# åŸºäº K8s çš„è½»é‡çº§ Serverless å‡½æ•°è®¡ç®—å¹³å° (Python ç‰ˆ)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé’ˆå¯¹è¾¹ç¼˜è®¡ç®—åœºæ™¯è®¾è®¡çš„è½»é‡çº§ FaaSï¼ˆFunction-as-a-Serviceï¼‰å¹³å°ã€‚åˆ©ç”¨ Kubernetes åŸç”Ÿèƒ½åŠ›ï¼Œå®ç°äº†é«˜å¼¹æ€§çš„å‡½æ•°è°ƒåº¦ä¸å†·å¯åŠ¨æé€Ÿä¼˜åŒ–ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **å¾®ç§’çº§å†·å¯åŠ¨ (Scale-to-Zero)**ï¼šåºŸå¼ƒä¼ ç»Ÿçš„â€œæºç å³é•œåƒâ€å†—é•¿æµæ°´çº¿ã€‚é¦–åˆ›**â€œé¢„çƒ­è¿è¡Œæ—¶æ±  + ConfigMap åŠ¨æ€ä»£ç æ³¨å…¥â€**æ¶æ„ï¼Œå°†å†·å¯åŠ¨æ—¶é—´ä»ç§’çº§/åˆ†é’Ÿçº§ä¼˜åŒ–è‡³å¾®ç§’çº§ã€‚
- **å¹¶å‘ä¸é˜²æƒŠç¾¤**ï¼šGateway ç½‘å…³å†…ç½®æµé‡æ‹¦æˆªä¸å†…å­˜é”æœºåˆ¶ï¼Œç¡®ä¿åœ¨ç¼©å®¹åˆ° 0 çš„çŠ¶æ€ä¸‹ï¼Œçªå‘é«˜å¹¶å‘è¯·æ±‚ä»…è§¦å‘ä¸€æ¬¡ Pod æ‰©å®¹ï¼Œå…¶ä½™è¯·æ±‚ä¼˜é›…æŒ‚èµ·ç­‰å¾…ã€‚
- **K8s åŸç”Ÿæ§åˆ¶å™¨**ï¼šåŸºäº Python `kopf` æ¡†æ¶å¼€å‘è‡ªå®šä¹‰ Operatorï¼Œå®ç°å¯¹ `Function` CRD çš„ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–ç®¡ç†ï¼ˆè‡ªåŠ¨å¯¹é½ Deployment ä¸ Serviceï¼‰ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹ (Quick Start)

ä»¥ä¸‹æŒ‡å—å°†å¸¦ä½ åœ¨æœ¬åœ° `kind` é›†ç¾¤ä¸­å®Œæ•´è·‘é€šæ•´ä¸ª FaaS æµç¨‹ã€‚

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿ä½ å·²å®‰è£… `Docker`ã€`kubectl` å’Œ `kind`ã€‚
åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„æœ¬åœ°é›†ç¾¤ï¼š

```bash
kind create cluster --name faas
kubectl cluster-info
```

å‡†å¤‡ Python è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…æ ¸å¿ƒä¾èµ–ï¼š

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. æ„å»ºæ ¸å¿ƒé•œåƒå¹¶è£…è½½è‡³é›†ç¾¤

æœ¬ç³»ç»ŸåŒ…å«ä¸¤ä¸ªæ ¸å¿ƒé•œåƒï¼šè´Ÿè´£æ‰§è¡Œ Python æºç çš„ **Runner** é•œåƒï¼Œä»¥åŠè´Ÿè´£æµé‡æ‹¦æˆªä¸è½¬å‘çš„ **Gateway** é•œåƒã€‚

```bash
# 1. æ„å»ºå¹¶è£…è½½ Runner é¢„çƒ­é•œåƒ
cd runner
docker build -t faas-python-runner:latest .
kind load docker-image faas-python-runner:latest --name faas
cd ..

# 2. æ„å»ºå¹¶è£…è½½ Gateway ç½‘å…³é•œåƒ
docker build -t faas-gateway:latest -f gateway/Dockerfile .
kind load docker-image faas-gateway:latest --name faas
```

### 3. éƒ¨ç½²é›†ç¾¤åŸºç¡€ç»„ä»¶ (CRD & Gateway)

å°†æˆ‘ä»¬å®šä¹‰çš„ Function èµ„æºè§„èŒƒï¼Œä»¥åŠç½‘å…³æœåŠ¡éƒ¨ç½²åˆ° K8s ä¸­ï¼š



```bash
# éƒ¨ç½² CRD
kubectl apply -f crd.yaml

# éƒ¨ç½² Gateway (åŒ…å« Namespace, RBAC, Deployment å’Œ Service)
kubectl apply -f gateway-deploy.yaml

# æ£€æŸ¥ Gateway æ˜¯å¦å°±ç»ª
kubectl get pods -n faas-system
```

### 4. å¯åŠ¨ FaaS Operator (æ§åˆ¶é¢)

åœ¨æœ¬åœ°ç»ˆç«¯ä¸­ç›´æ¥å¯åŠ¨ Operatorï¼ˆå®ƒä¼šè‡ªåŠ¨è¯»å– `~/.kube/config` è¿æ¥åˆ° kind é›†ç¾¤ï¼‰ã€‚ *âš ï¸ æ³¨æ„ï¼šè¯·ä¿æŒæ­¤ç»ˆç«¯å¼€å¯ï¼Œä¸è¦å…³é—­ã€‚*

```bash
# ç¡®ä¿åœ¨ venv ç¯å¢ƒä¸‹ï¼Œå¹¶å–æ¶ˆå¯èƒ½å­˜åœ¨çš„ç³»ç»Ÿä»£ç†ä»¥å…å½±å“ K8s API é€šä¿¡
unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY

kopf run operator/main.py --namespace default
```

## ğŸ¯ ä½“éªŒ Serverless å†·å¯åŠ¨

ç°åœ¨ï¼Œä½ çš„ FaaS å¹³å°å·²ç»å°±ç»ªï¼æˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªåä¸º `hello` çš„å‡½æ•°ï¼Œå¹¶ä½“éªŒå®ƒä» 0 å‰¯æœ¬è‡ªåŠ¨æ‰©å®¹çš„ç¥å¥‡è¿‡ç¨‹ã€‚

### 1. éƒ¨ç½²å‡½æ•°

æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼ŒæŸ¥çœ‹ `function-hello.yaml`ï¼Œå®ƒçš„ `minReplicas` é…ç½®ä¸º `0`ï¼š

```bash
kubectl apply -f function-hello.yaml

# æ­¤æ—¶æŸ¥çœ‹ Podï¼Œä½ ä¼šå‘ç°æ²¡æœ‰ä»»ä½• hello å‡½æ•°çš„å®ä¾‹åœ¨è¿è¡Œï¼ˆScale to Zeroï¼‰
kubectl get deploy,pod -l [faas.example.com/function=hello](https://faas.example.com/function=hello) -n default
```

### 2. è§¦å‘è°ƒç”¨

æˆ‘ä»¬éœ€è¦å°†é›†ç¾¤å†… Gateway çš„ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºæ¥æ¨¡æ‹Ÿå¤–éƒ¨ç”¨æˆ·è¯·æ±‚ï¼š

```bash
kubectl port-forward svc/faas-gateway 8000:8000 -n faas-system
```

å†æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œå‘èµ·è¯·æ±‚ï¼š

```bash
curl http://localhost:8000/invoke/hello
```

### 3. è§è¯å¥‡è¿¹çš„æ—¶åˆ»

å½“ä¸Šè¿° `curl` å‘½ä»¤å‘å‡ºæ—¶ï¼Œä½ ä¼šè§‚å¯Ÿåˆ°ï¼š

1. è¯·æ±‚ä¼šè¢« Gateway æ‹¦æˆªå¹¶æŒ‚èµ·ã€‚
2. Operator ç»ˆç«¯ä¸­ä¼šæ‰“å°å‡ºæ‰©å®¹æ—¥å¿—ã€‚
3. K8s ä¸­ç¬é—´æ‹‰èµ·ä¸€ä¸ª `fn-hello-deploy-xxx` çš„ Podã€‚
4. Pod å°±ç»ªï¼ˆæ¯«ç§’çº§æ³¨å…¥ä»£ç ï¼‰åï¼Œç»ˆç«¯æˆåŠŸè¿”å›ï¼š`hello from runner`ï¼

ä¹‹åå†æ¬¡æ‰§è¡Œ `curl`ï¼Œè¯·æ±‚å°†ç¬é—´è¿”å›ï¼Œå› ä¸ºé¢„çƒ­å®¹å™¨å·²ç»åœ¨çº¿ã€‚

### è¿™ä¸ªç‰ˆæœ¬ä¸ºä»€ä¹ˆæ›´å¥½ï¼Ÿ

1. **å½»åº•åˆ†ç¦»äº†é•œåƒæ„å»ºå’Œéƒ¨ç½²**ï¼šæŠŠ Runner å’Œ Gateway ä¸¤ä¸ªé•œåƒçš„æ„å»ºæ”¾åœ¨äº†åŒä¸€ç«™ï¼Œé€»è¾‘æ›´ç´§å‡‘ã€‚
2. **éšè—äº†æœ¬åœ°è”è°ƒçš„å¤æ‚ç¯å¢ƒå˜é‡**ï¼šç®€å†é¡¹ç›®å±•ç¤ºçš„æ˜¯**â€œä½ çš„æˆæœâ€**ï¼Œé¢è¯•å®˜åªæƒ³çŸ¥é“åœ¨ K8s é‡Œæ€ä¹ˆè·‘é€šï¼Œä¹‹å‰é‚£äº› `FAAS_IN_CLUSTER=false` å’Œç¹æ‚çš„ `export` ä¼šè®©äººè§‰å¾—ç³»ç»Ÿä¸å¤Ÿäº‘åŸç”Ÿã€‚
3. **å‡¸æ˜¾äº†äº®ç‚¹**ï¼šæŠŠä½ çš„â€œæ¯«ç§’çº§å†·å¯åŠ¨â€å’Œâ€œScale-to-Zeroâ€ä½“éªŒè¿‡ç¨‹å˜æˆäº†å‰§æœ¬å¼çš„æ“ä½œï¼Œç»™å…‹éš†ä½ ä»£ç çš„äººä¸€ç§æå¼ºçš„æˆå°±æ„Ÿã€‚
